<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drive Caster Pro</title>
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="Cast videos from Google Drive to your Chromecast.">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDQ4NCA0ODQiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSJhIiB4MT0iMCUiIHkxPSIwJSIgeDI9IjEwMCUiIHkyPSIxMDAlIj48c3RvcCBvZmZzZXQ9IjAlIiBzdG9wLWNvbG9yPSIjNjY3ZWVhIi8+PHN0b3Agb2Zmc2V0PSIxMDAlIiBzdG9wLWNvbG9yPSIjNzY0YmEyIi8+PC9saW5lYXJHcmFkaWVudD48L2RlZnM+PHJlY3Qgd2lkdGg9IjQ4NCIgaGVpZ2h0PSI0ODQiIHJ4PSI5NiIgZmlsbD0idXJsKCNhKSIvPjx0ZXh0IHg9IjI0MiIgeT0iMjkwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMjAwIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+8J+OrDwvdGV4dD48dGV4dCB4PSIyNDIiIHk9IjM4MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjQ4IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+RHJpdmU8L3RleHQ+PC9zdmc+">
    <style>
        :root { --accent-color: #667eea; --accent-color-dark: #764ba2; --text-color: #ffffff; --card-bg: rgba(255, 255, 255, 0.1); }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, var(--accent-color) 0%, var(--accent-color-dark) 100%); min-height: 100vh; color: var(--text-color); }
        .container { max-width: 700px; margin: 0 auto; padding: 20px; }
        .card { background: var(--card-bg); backdrop-filter: blur(10px); border-radius: 15px; padding: 30px; margin-bottom: 20px; border: 1px solid rgba(255, 255, 255, 0.2); }
        h1 { text-align: center; margin-bottom: 30px; font-size: 2.5rem; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        h3 { color: #ffd700; margin-bottom: 15px; }
        .input-group { margin-bottom: 20px; }
        input { width: 100%; padding: 15px; border: none; border-radius: 10px; font-size: 16px; background: rgba(255, 255, 255, 0.9); color: #333; }
        .btn { background: #4285f4; color: white; border: none; padding: 15px; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; transition: transform 0.2s; }
        .btn:hover { transform: translateY(-2px); }
        .btn#signOutBtn { background: #666; }
        #cast_button_container { margin-top: 10px; }
        google-cast-button { --google-cast-button-background-color: #4ecdc4; width: 100%; height: 50px; border-radius: 10px; }
        .item { background: var(--card-bg); border-radius: 10px; padding: 15px; margin-bottom: 10px; display: flex; align-items: center; gap: 15px; cursor: pointer; transition: background 0.2s; }
        .item:hover { background: rgba(255, 255, 255, 0.2); }
        .item-name { flex-grow: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        #breadcrumb { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; }
        #breadcrumb div { cursor: pointer; }
        #breadcrumb div:hover { text-decoration: underline; }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: #fff; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé¨ Drive Caster</h1>
        <div id="authCard" class="card">
            <h3>Setup</h3>
            <div class="input-group">
                <label for="clientId">Google OAuth Client ID:</label>
                <input type="text" id="clientId" placeholder="Paste your Web App Client ID">
            </div>
            <button id="authBtn" class="btn">üîê Sign In with Google</button>
        </div>
        <div id="mainApp" style="display:none;">
            <button id="signOutBtn" class="btn">Sign Out</button>
            <div id="cast_button_container"></div>
            <div id="browserCard" class="card" style="margin-top:20px;">
                <div id="breadcrumb"></div>
                <div id="fileList"></div>
            </div>
        </div>
    </div>
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1" async defer></script>

    <script>
        const authCard = document.getElementById('authCard');
        const mainApp = document.getElementById('mainApp');
        const clientIdInput = document.getElementById('clientId');
        const authBtn = document.getElementById('authBtn');
        const signOutBtn = document.getElementById('signOutBtn');
        const fileListDiv = document.getElementById('fileList');
        const breadcrumbDiv = document.getElementById('breadcrumb');
        
        let gapiClient;
        let tokenClient;
        let castSession;
        let folderStack = [{ id: 'root', name: 'My Drive' }];

        window.onload = () => {
            clientIdInput.value = localStorage.getItem('driveCasterClientId') || '';
            authBtn.addEventListener('click', handleAuthClick);
            signOutBtn.addEventListener('click', handleSignOutClick);
            // The GIS and GAPI scripts are loaded async, so we wait for them.
            // The actual initialization will happen on button click.
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./sw.js').then(reg => console.log('SW Registered', reg)).catch(err => console.error('SW Reg Error', err));
            }
        };
        
        function handleAuthClick() {
            const clientId = clientIdInput.value;
            if (!clientId) { alert('Please enter a Client ID.'); return; }
            localStorage.setItem('driveCasterClientId', clientId);

            // 1. Initialize the token client for getting Drive access
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: clientId,
                scope: 'https://www.googleapis.com/auth/drive.readonly',
                callback: (tokenResponse) => {
                    // This function is called when the user grants permission
                    if (tokenResponse && tokenResponse.access_token) {
                        // Set the access token for all future GAPI requests
                        gapi.client.setToken(tokenResponse);
                        // Now that we have a token, we can load the Drive API
                        loadDriveApiAndShowUI();
                    }
                },
            });

            // 2. Load GAPI client and then request a token
            gapi.load('client', () => {
                gapi.client.load('https://www.googleapis.com/discovery/v1/apis/drive/v3/rest').then(() => {
                    // Ask the user for permission to access their Drive
                    tokenClient.requestAccessToken();
                });
            });
        }

        function loadDriveApiAndShowUI() {
            updateUiForSignIn();
        }

        function handleSignOutClick() {
            // There's no formal sign-out with the new library, we just clear the state
            gapi.client.setToken(null);
            authCard.style.display = 'block';
            mainApp.style.display = 'none';
        }

        function updateUiForSignIn() {
            authCard.style.display = 'none';
            mainApp.style.display = 'block';
            initializeCastApi(); // Initialize cast now that user is signed in
            loadFiles(folderStack[folderStack.length - 1].id);
        }
        
        function initializeCastApi() {
            if (window.cast && cast.framework) {
                cast.framework.CastContext.getInstance().setOptions({
                    receiverApplicationId: chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,
                    autoJoinPolicy: chrome.cast.AutoJoinPolicy.TAB_AND_ORIGIN_SCOPED
                });
                const castButton = document.createElement('google-cast-button');
                const container = document.getElementById('cast_button_container');
                container.innerHTML = ''; // Clear previous button if any
                container.appendChild(castButton);
            } else {
                console.error("Cast framework not available yet");
            }
        }

        async function loadFiles(folderId) {
            fileListDiv.innerHTML = '<div class="spinner"></div>';
            updateBreadcrumb();
            try {
                const response = await gapi.client.drive.files.list({
                    q: `'${folderId}' in parents and (mimeType='application/vnd.google-apps.folder' or mimeType contains 'video/') and trashed=false`,
                    fields: 'files(id, name, mimeType)',
                    orderBy: 'folder,name'
                });
                displayFileList(response.result.files || []);
            } catch (error) {
                console.error('File Load Error:', error);
                fileListDiv.innerText = 'Error loading files.';
            }
        }

        function displayFileList(files) {
            fileListDiv.innerHTML = '';
            if (!files.length) fileListDiv.innerText = 'No files or folders found.';
            files.forEach(file => {
                const isFolder = file.mimeType === 'application/vnd.google-apps.folder';
                const item = document.createElement('div');
                item.className = 'item';
                item.innerHTML = `<span>${isFolder ? 'üìÅ' : 'üé¨'}</span><span class="item-name">${file.name}</span>`;
                item.onclick = () => isFolder ? handleFolderClick(file.id, file.name) : castVideo(file.id, file.name);
                fileListDiv.appendChild(item);
            });
        }

        function handleFolderClick(folderId, folderName) {
            folderStack.push({ id: folderId, name: folderName });
            loadFiles(folderId);
        }

        function updateBreadcrumb() {
            breadcrumbDiv.innerHTML = '';
            folderStack.forEach((folder, index) => {
                const crumb = document.createElement('div');
                crumb.innerText = folder.name + (index < folderStack.length - 1 ? ' >' : '');
                crumb.onclick = () => navigateToBreadcrumb(index);
                breadcrumbDiv.appendChild(crumb);
            });
        }

        function navigateToBreadcrumb(index) {
            folderStack = folderStack.slice(0, index + 1);
            loadFiles(folderStack[index].id);
        }

        function castVideo(fileId, fileName) {
            castSession = cast.framework.CastContext.getInstance().getCurrentSession();
            if (!castSession) { alert('Connect to a Chromecast first!'); return; }
            
            const accessToken = gapi.client.getToken().access_token;
            const videoUrl = `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`;
            const mediaInfo = new chrome.cast.media.MediaInfo(videoUrl, 'video/mp4');
            mediaInfo.metadata = new chrome.cast.media.GenericMediaMetadata();
            mediaInfo.metadata.title = fileName;
            mediaInfo.customData = { "headers": { "Authorization": "Bearer " + accessToken } };
            const request = new chrome.cast.media.LoadRequest(mediaInfo);
            castSession.loadMedia(request).then(() => console.log('Casting...'), (err) => console.error('Cast Error', err));
        }
    </script>
</body>
</html>